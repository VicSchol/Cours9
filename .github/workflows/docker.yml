name: Build and Test Project

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          if [ -d "tests" ]; then
            # Exclut test_api.py qui touche FAISS
            pytest -k "not test_api" -q
          else
            echo "No tests folder found, skipping."
          fi

      ###############################################
      # üßπ CLEANUP DOCKER BEFORE BUILDING THE IMAGE
      ###############################################
      - name: Free disk space (Docker & system)
        run: |
          echo "Disk space BEFORE cleanup:"
          df -h

          # Remove unused Docker data
          docker system prune -af --volumes || true

          # Remove large unnecessary system files
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/lib/android

          # Clean apt cache
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

          echo "Disk space AFTER cleanup:"
          df -h

      ###############################################
      # üèóÔ∏è BUILD DOCKER IMAGE
      ###############################################
      - name: Build Docker image
        run: docker build -t mon-projet .
